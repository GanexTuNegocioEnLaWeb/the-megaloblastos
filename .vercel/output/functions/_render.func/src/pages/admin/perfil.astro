---
import { getSession } from "auth-astro/server";
import Layout from "../../layouts/Layout.astro"
import { SignOut } from "auth-astro/components"
import FormSupport from "@/components/FormSupport.vue";
import { db, eq, Users } from "astro:db";

// get session
const theUser = await getSession(Astro.request);
if (!theUser) return Astro.redirect('/');

const user = await db.select().from(Users).where(eq(Users.email, theUser.user.email)).all();
console.log("user:", user)
---

<Layout title="Perfil">
    <section class="w-[80dvw] mx-auto max-w-6xl px-8">
        <article class="py-10 flex justify-center flex-col md:flex-row items-center gap-4">
            <img src={theUser.user.image} alt={`perfil de ${theUser.user.name}`}>
            <div class="flex flex-col items-center md:items-start">
                <h1 class="text-3xl font-bold text-neutral-800 dark:text-neutral-50 text-ellipsis overflow-hidden text-nowrap max-w-56 sm:max-w-80 md:max-w-96">{theUser.user.name}</h1>
                <p class="text-neutral-600 dark:text-neutral-300 text-center md:text-left">{theUser.user.email}</p>
                <SignOut class="text-red-500 underline">Cerrar sesión</SignOut>
            </div>
        </article>
        <a href="/" class="text-primary underline inline-block">Volver a inicio</a>
        {user.length == 0 ? <p class="text-neutral-600 dark:text-neutral-300 text-center">En construcción</p>:<>
        <article class="py-5">
            <h2 class="text-3xl font-bold text-neutral-800 dark:text-neutral-50">Administrar</h2>
            <p class="text-neutral-600 dark:text-neutral-300">Panel de administración</p>
        </article>

        <FormSupport client:load />
        </>
        }
    </section>
</Layout>
